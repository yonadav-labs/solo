{% extends 'base.html' %}
{% load staticfiles %} 

{% block main %}
<div class="container">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
    <h4>Select your location on the Map:</h4>
	<div class="row">
        <div class="col-md-8">
            <div id="mapid" style="height: 200px; margin-bottom: 30px;"></div>
        </div>
    </div>
    <form method="post" action="./">
        {% csrf_token %}
        <input id="id_address" name="address" value="{{ location2 }}" type="hidden">
    </form>


    {% if sellers %}
        <h4>Select a nearby Seller:</h4>
        <div class="col-md-7">
            {% for seller in sellers %}	
				<div class="media">
					<div class="media-left">
						<a href="javascript::void(0);" onclick="start_order({{ seller.id }});">
							<img src="/static/media/{{ seller.picture }}" class="img-responsive" >
						</a>
					</div>
						<div class="media-body">
								<b class="media-heading">{{ seller.first_name }}</b>Distance: {{ seller.distance.mi }} Miles away.</p>
								<p> {{seller.item}} {{seller.description}}  </p>
						</div>
                </div>
				<nav>
				  <ul class="pager">
					<li><a href="#">Previous</a></li>
					<li><a href="#">See More</a></li>
				  </ul>
				</nav>
            {% endfor %}
        <div id="order_div"></div>
        </div>
    {% else %}
        <h4>No sellers are found nearby.</h4> 
    	<b><u><a href = "/login">Become a seller.</a></u></b>
    {% endif %}

</div>
{% endblock %}

{% block javascript %}
<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
<script>
    // execute on load
    var customer_location = '{{ location1 }}';

    var mymap = L.map('mapid').setView([{{ location1 }}], 11);

    // get location on map initialize
    function onLocationFound(e) {
    	// get current location
    	$('#id_address').val(e.latlng.lng+' '+e.latlng.lat);
    	customer_location = e.latlng.lat+','+e.latlng.lng; 
    }
    	
    function onLocationError(e) {
    	// alert(e.message);
    }

    	
    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
        maxZoom: 20,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a>',
        id: 'mapbox.streets'
    }).addTo(mymap);

    var currentIcon = L.icon({
        iconUrl: '{% static "img/PIN.png" %}',
        iconSize:     [50, 45], // size of the icon
        iconAnchor:   [13, 35], // point of the icon which will correspond to marker's location
        popupAnchor:  [0, -24] // point from which the popup should open relative to the iconAnchor
    });

    var marker = L.marker([{{ location1 }}], {icon: currentIcon}).addTo(mymap).bindPopup('You Are Here!')
      .openPopup(); 
      
    // add markers for sellers
    {% for seller in sellers %}
        L.marker([{{ seller.location.y }}, {{ seller.location.x }}]).addTo(mymap).bindPopup('{{ seller.first_name }}');        
    {% endfor %}

    function onMapClick(e) {
        $('#id_address').val(e.latlng.lng+' '+e.latlng.lat);
        customer_location = e.latlng.lat+','+e.latlng.lng; 
        // remove current marker
        mymap.removeLayer(marker); 
    	// set the location of the marker
        marker = L.marker(e.latlng, {icon: currentIcon}).addTo(mymap).openPopup() //.bindPopup(pos).openPopup();
    		.setLatLng(e.latlng);
    	
    	// execute on load of new clicked location
    	$(document).ready(function () {
    		window.document.forms[0].submit();
    	});

    }

    mymap.on('click', onMapClick);
    mymap.on('locationfound', onLocationFound);
    mymap.on('locationerror', onLocationError);
</script>   
<script>
    function start_order(seller_id) 
    {
        $.post('/start_order/', 'id='+seller_id+'&location='+customer_location)
        .success(function(data){
          $('#order_div').html(data);
        });
    }
</script>
{% endblock %}