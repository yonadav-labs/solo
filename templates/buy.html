{% extends 'base.html' %}
{% load staticfiles %} 

{% block main %}

<div class="container">
<link rel="stylesheet" href="/static/css/leaflet.css" />
<div class="row">
    <div class="col-md-8" id="map_wrapper">
        <h4>Select your location on the Map:</h4>
        <div id="mapid" style="height: 200px; margin-bottom: 30px;"></div>
    </div>
    <form method="post">
        {% csrf_token %}
        <input id="id_address" name="address" value="{{ location2 }}" type="hidden">
    </form>

    {% if sellers %}			
        <div class="col-md-7" id="seller_wrapper">
            <h3>Select a nearby Seller:</h3>
            {% for seller in sellers %}	
                <a href="javascript:void(0);" onclick="start_order({{ seller.id }}, {{ seller.distance.mi|floatformat:2 }});">
				<div class="media">
					<div class="media-left">
						<img src="/static/media/{{ seller.picture }}" class="item-thumbnail" >
					</div>
					<div class="media-body">
						<b class="media-heading">{{ seller.first_name }}</b>
                        <p>Distance: {{ seller.distance.mi|floatformat:2 }} Miles away.</p>
						<p> {{seller.item}} {{seller.description}} </p>
					</div>    
                </div>
                </a>
            {% endfor %}
        </div>
        <div class="col-md-7">
            <div id="order_div"></div>
        </div>
    {% else %}
		<div class="col-md-7">
            <h4>We need Sellers in your area:</h4> 
        	<b><u><a href = "/login">Begin Selling Now</a></u></b>
		</div>
	{% endif %}
</div>
{% endblock %}

{% block javascript %}
<script src="/static/js/leaflet.js"></script>
<script>
    {% if map_initial %}
        navigator.geolocation.getCurrentPosition(function(position) {
            $('#id_address').val(position.coords.longitude+' '+position.coords.latitude);
            // console.log(position.coords.longitude+' '+position.coords.latitude);
            window.document.forms[0].submit();    
        }, function(error) {
            if (error.code == 1)
                alert('Please allow Safari to access your location:\n Go to Settings->Privacy->Location Services and toggling Safari to On.');
            else
                alert('Error occurred. Error code: ' + error.code);
        });
    {% endif %}

    var customer_location = '{{ location1 }}';        
    var mymap = L.map('mapid').setView([{{ location1 }}], 11);

    L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoiZ2V0ZnJlc2hiYWtlZCIsImEiOiJjaXBzbjdoZGUwM3oxZnZtMmltazJ0eHU4In0.B9Vu_0d7ZJlCXfwP5V_s5A', {
        maxZoom: 20,
        attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a>',
        id: 'mapbox.streets'
    }).addTo(mymap);

    var currentIcon = L.icon({
        iconUrl: '{% static "img/PIN.png" %}',
        iconSize:     [50, 45], // size of the icon
        iconAnchor:   [13, 35], // point of the icon which will correspond to marker's location
        popupAnchor:  [0, -24]  // point from which the popup should open relative to the iconAnchor
    });

    var marker = L.marker([{{ location1 }}], {icon: currentIcon}).addTo(mymap).bindPopup('You Are Here!')
      .openPopup(); 
      
    // add markers for sellers
    {% for seller in sellers %}
        L.marker([{{ seller.location.y }}, {{ seller.location.x }}]).addTo(mymap).bindPopup('{{ seller.first_name }}');        
    {% endfor %}

    function onMapClick(e) {
        $('#id_address').val(e.latlng.lng+' '+e.latlng.lat);
        customer_location.lat = e.latlng.lat;
        customer_location.lon = e.latlng.lon;

        // update current marker
        mymap.removeLayer(marker); 
        marker = L.marker(e.latlng, {icon: currentIcon}).addTo(mymap).openPopup().setLatLng(e.latlng);
    	
    	// execute on load of new clicked location
		window.document.forms[0].submit();    
    }

    mymap.on('click', onMapClick);
</script> 
{% endblock %}