{% extends 'base.html' %}
{% load staticfiles %} 

{% block content %}
<div class="container">
<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />
<br><br><br> <!-- removed header tags and spacing with break tags so that map begins below bootstap css -->
<div class="row">
<div class="col-md-8">
<div id="mapid" style="height: 200px; margin-bottom: 30px;"></div>
</div>
</div>
<form method="post" action="./">
    {% csrf_token %}
    <input id="id_address" name="address" value="{{ location2 }}" type="hidden">
</form>


{% if sellers %}
<h3>Select a seller:</h3>
<ul>
    {% for seller in sellers %}
    <li><a href="javascript::void(0);" onclick="start_order({{ seller.id }});">{{ seller.picture }}<b>{{ seller.name }}</b>: Distance: {{ seller.distance.mi }} Miles away.</a></li>
    {% endfor %}
</ul>
<div class="row">
<div class="col-md-6">
<div id="order_div"></div>
</div>
</div>
{% else %}
<h3>Select your location on the Map:</h3> 
	<li><b><u><a href = "/login">Apply Now.</a></u></b></li>
{% endif %}
</div>
{% endblock %}

{% block javascript %}
<script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
<script>
// execute on load


var customer_location = '{{ location1 }}';

var mymap = L.map('mapid');

<!-- get location on map initialize-->
	function onLocationFound(e) {
		// get current location
		$('#id_address').val(e.latlng.lng+' '+e.latlng.lat);
		customer_location = e.latlng.lat+','+e.latlng.lng; 
		
		}
		
	function onLocationError(e) {
		alert(e.message);
		}

	
L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
    maxZoom: 20,
    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a>',
    id: 'mapbox.streets'
}).addTo(mymap);

var currentIcon = L.icon({
    iconUrl: '{% static "img/PIN.png" %}',
    iconSize:     [50, 45], // size of the icon
    iconAnchor:   [13, 35], // point of the icon which will correspond to marker's location
    popupAnchor:  [0, -24] // point from which the popup should open relative to the iconAnchor
});

var marker = L.marker([{{ location1 }}], {icon: currentIcon}).addTo(mymap).bindPopup('You Are Here!')
  .openPopup(); 
  
// add markers for sellers
{% for seller in sellers %}
    L.marker([{{ seller.location.y }}, {{ seller.location.x }}]).addTo(mymap).bindPopup('{{ seller.name }}');        
{% endfor %}

function onMapClick(e) {
    $('#id_address').val(e.latlng.lng+' '+e.latlng.lat);
    customer_location = e.latlng.lat+','+e.latlng.lng; 
    // remove current marker
    mymap.removeLayer(marker); 
    // add updated current marker title
    //var pos = e.latlng.lat+' '+e.latlng.lng;
	// set the location of the marker
    marker = L.marker(e.latlng, {icon: currentIcon}).addTo(mymap).openPopup() //.bindPopup(pos).openPopup();
		.setLatLng(e.latlng);
	
	// execute on load of new clicked location
	$(document).ready(function () {
		window.document.forms[0].submit();
	});

	}



// set location 
mymap.locate({setView: true, maxZoom: 16});
	
mymap.on('click', onMapClick);
// HEAD
    
//=======
<!-- add get location -->
mymap.on('locationfound', onLocationFound);
mymap.on('locationerror', onLocationError);


 
</script>   
<script> //54430a2559d7efa2b800ae84fbf51bd6a33fac22

function start_order(seller_id) 
{
    $.post('/start_order/', 'id='+seller_id+'&location='+customer_location)
    .success(function(data){
      $('#order_div').html(data);
    });
}
</script>


{% endblock %}